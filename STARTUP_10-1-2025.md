# ChurnGuard Database Reconstruction - October 1, 2025

## Overview
After fixing critical bugs in account eligibility logic (specifically the LAUNCHED accounts with `earliest_unit_archived_at` bug), we need to reconstruct historical data with corrected logic.

## Critical Bugs Fixed (Sept 30, 2025)
1. **LAUNCHED accounts with earliest_unit_archived_at were excluded** - 13 accounts affected (including Russo's)
2. **Archived accounts missing September data** - Archive date comparison logic was incorrect
3. **Pre-launch platform fees not captured** - Accounts launching mid-month missed fees assessed on 1st
4. **NULL launch date accounts with revenue excluded** - Needed revenue-based discovery

## What Needs to Be Done

### Step 1: Accounts Sync (Required First)
Ensures all accounts with corrected eligibility criteria are in the database.

```bash
# SSH to Render
render ssh churnguard-production-web

# Run accounts sync
nohup node etl/postgresql-native/accounts-etl-postgres-native.js > /tmp/accounts-sync.log 2>&1 &

# Check progress
tail -f /tmp/accounts-sync.log
```

**Expected outcome:** All accounts with valid launch dates or revenue activity are synced.

---

### Step 2: Daily Metrics Backfill (Oct 2024 - Sep 2025)
Reconstructs all daily metrics with corrected eligibility logic using optimized single-query-per-month approach.

**Date Range:** October 1, 2024 - September 29, 2025 (12 months)

```bash
# Still in Render shell
nohup node etl/postgresql-native/backfill-all-historical.js > /tmp/daily-backfill.log 2>&1 &

# Monitor progress
tail -f /tmp/daily-backfill.log
```

**What this does:**
- Processes 12 months: Oct 2024 - Sep 2025
- For each month: Fetches all daily data in ONE BigQuery query
- Batch upserts to PostgreSQL in chunks of 500
- Continues even if one month fails

**Expected time:** Much faster than day-by-day (12 BigQuery queries total vs 365+)

**Expected outcome:** All daily_metrics records updated with corrected eligibility criteria.

---

### Step 3: Monthly Rollup (Oct 2024 - Sep 2025)
Aggregates corrected daily metrics into monthly_metrics.

```bash
# Wait for Step 2 to complete, then run
nohup node etl/postgresql-native/rollup-all-historical-monthly.js > /tmp/monthly-rollup.log 2>&1 &

# Monitor progress
tail -f /tmp/monthly-rollup.log
```

**What this does:**
- Processes same 12 months
- Aggregates daily metrics → monthly metrics
- Calculates risk levels, trending metrics, etc.

**Expected outcome:** All monthly_metrics records updated, UI data accurate.

---

### Step 4: Verify Results

1. **Check Russo's appears in UI:**
   - Account ID: `recjLJrk2hwII4po3`
   - Should now show in all views (was missing due to earliest_unit_archived_at bug)

2. **Verify 13 LAUNCHED accounts restored:**
   ```sql
   SELECT account_id, account_name, status, earliest_unit_archived_at
   FROM accounts
   WHERE status = 'LAUNCHED'
     AND earliest_unit_archived_at IS NOT NULL;
   ```

3. **Check year-over-year comparisons work:**
   - September 2025 vs September 2024 should show meaningful data
   - Historical Performance view should be accurate

4. **Verify archived accounts have full September data:**
   ```sql
   SELECT account_id, COUNT(*) as days
   FROM daily_metrics
   WHERE date >= '2025-09-01' AND date <= '2025-09-29'
     AND account_id IN (
       SELECT account_id FROM accounts WHERE status = 'ARCHIVED'
     )
   GROUP BY account_id
   ORDER BY days DESC;
   ```

---

## Important Notes

- **Run in order:** Accounts sync → Daily backfill → Monthly rollup
- **Use nohup:** Ensures processes continue even if shell disconnects
- **Monitor logs:** Check progress periodically with `tail -f`
- **Start date adjusted:** Only going back to Oct 2024 (not Aug 2024) - 12 months instead of 14

## Files Modified (All Committed & Deployed)

**ETL Logic:**
- `etl/postgresql-native/accounts-etl-postgres-native.js` - Revenue-based discovery, ACTIVE status
- `etl/postgresql-native/daily-metrics-etl-postgres-native.js` - Fixed archive logic, pre-launch fees, earliest_unit_archived_at
- `etl/postgresql-native/monthly-rollup-etl-postgres-native.js` - Fixed earliest_unit_archived_at filtering

**UI Services (6 files fixed):**
- `src/services/monthly-trends.service.js`
- `src/services/historical-performance.service.js`
- `src/services/account-metrics-monthly.service.js`
- `src/services/account-metrics-weekly.service.js`
- `src/services/accounts.service.js`
- `src/services/hubspot-sync.js`

**Backfill Scripts (Temporary):**
- `etl/postgresql-native/backfill-all-historical.js` - Daily backfill automation
- `etl/postgresql-native/rollup-all-historical-monthly.js` - Monthly rollup automation
- `etl/postgresql-native/backfill-month-optimized.js` - Optimized single-month backfill

---

## Success Criteria

✅ All 13 LAUNCHED accounts with earliest_unit_archived_at appear in UI
✅ Archived accounts have complete September 2025 data
✅ Year-over-year comparisons show accurate trends
✅ Pre-launch platform fees captured correctly
✅ NULL launch date accounts with revenue included

---

## Troubleshooting

**If daily backfill fails on a specific month:**
- Check logs for the specific error
- Can run individual month: `node etl/postgresql-native/backfill-month-optimized.js YYYY-MM`
- Then continue with remaining months

**If monthly rollup fails:**
- Daily data is safe, can re-run rollup without re-doing daily
- Can run individual month: `node etl/shared-scripts/cron-manager.js historical YYYY-MM`

**If foreign key violations occur:**
- Re-run accounts sync first
- Then re-run daily backfill

---

## Cleanup After Completion

Once verified, delete temporary backfill scripts:
```bash
rm etl/postgresql-native/backfill-all-historical.js
rm etl/postgresql-native/backfill-month-optimized.js
rm etl/postgresql-native/rollup-all-historical-monthly.js
```

Production ETL will continue running daily with corrected logic automatically.
